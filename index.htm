<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>صانع تقارير برغموت</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">



  <style>
    :root {
      --vantablack: #000000;
      --matrix-green: #00FF41;
      --text-white: #e0e0e0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }

    body,
    p,
    div,
    span,
    table,
    td,
    th,
    li,
    input,
    textarea,
    button {
      font-family: "IBM Plex Arabic", "Arial", sans-serif;
      font-weight: 400 !important;
      font-style: normal !important;
    }

    .ltr,
    [lang="en"],
    [dir="ltr"],
    .english-text {
      font-family: "Arial", sans-serif !important;
      font-weight: 400 !important;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    .title,
    .heading,
    .bold-text {
      font-weight: 700 !important;
    }

    body {
      font-family: "IBM Plex Arabic", "Arial", sans-serif;
      background: var(--vantablack);
      color: var(--text-white);
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    .code-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: #000;
      overflow: hidden;
    }

    .code-bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(ellipse at 30% 50%, rgba(0, 0, 0, .1) 0%, rgba(0, 0, 0, .5) 50%, rgba(0, 0, 0, .95) 100%),
        linear-gradient(to right, rgba(0, 0, 0, .2) 0%, rgba(0, 0, 0, 0) 40%, rgba(0, 0, 0, .9) 100%);
      pointer-events: none;
    }

    .matrix-container {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      overflow: visible;
    }

    .code-stream {
      position: absolute;
      left: 0;
      top: 0;
      padding: 20px;
      color: rgba(0, 255, 65, .85);
      font-family: "IBM Plex Arabic", Consolas, Monaco, "Courier New", monospace;
      font-size: 13px;
      line-height: 1.8;
      white-space: pre;
      direction: ltr;
      text-align: left;
      min-width: 100%;
      width: max-content;
      animation: codeUp 100s linear infinite;
    }

    @keyframes codeUp {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(-50%);
      }
    }

    .app {
      position: relative;
      z-index: 1;
      height: auto;
      min-height: 100vh;
      max-height: 100vh;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 100vw;
      overflow-x: hidden;
      overflow-y: auto;
      padding-bottom: 4cm;
    }

    header {
      width: 100%;
      padding: 20px 14px 12px;
      text-align: center;
    }

    .title-tech {
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      color: #666;
      letter-spacing: 1px;
      margin-bottom: -8px;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 400 !important;
    }

    .bergamot-neon {
      font-size: clamp(2rem, 8vw, 3.8rem);
      font-weight: 700 !important;
      color: #2A5F02;
      line-height: 1.15;
      text-shadow: 0 0 20px rgba(42, 95, 2, .6);
      font-family: "IBM Plex Arabic", sans-serif;
    }

    .main {
      flex: 0 0 auto;
      width: 100%;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 6px 10px 10px;
    }

    .container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: -6px;
      padding: 0 10px;
    }

    .parts-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      padding: 8px;
      min-height: 28px;
      max-width: 560px;
      width: 100%;
    }

    .part-chip {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: rgba(0, 255, 65, .08);
      border: 1px solid rgba(0, 255, 65, .4);
      border-radius: 3px;
      position: relative;
      flex-shrink: 0;
    }

    .part-chip span {
      color: var(--matrix-green);
      font-size: 0.75rem;
      font-weight: bold;
      font-family: "Arial", sans-serif;
    }

    .part-chip button {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff3333;
      color: white;
      border: 1px solid var(--vantablack);
      font-size: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .part-chip:hover button {
      opacity: 1;
    }

    .matrix-border {
      position: relative;
      width: 100%;
      max-width: 560px;
      padding: clamp(6px, 2vw, 10px);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(0, 255, 65, .10);
      background: #000;
    }

    #htmlInput {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 280px;
      max-height: 45vh;
      min-height: 200px;
      background-color: rgba(5, 5, 5, .85);
      color: var(--matrix-green);
      border: 1px solid rgba(0, 255, 65, .2);
      border-radius: 12px;
      padding: 16px;
      font-family: "IBM Plex Arabic", Consolas, Monaco, "Courier New", monospace;
      font-size: clamp(12px, 3vw, 13px);
      resize: none;
      outline: none;
      display: block;
      box-shadow: inset 0 0 30px #000;
      line-height: 1.5;
      font-weight: 400 !important;
      overflow-y: auto;
      transition: none !important;
      -webkit-user-modify: read-write-plaintext-only;
      overflow-wrap: break-word;
      word-wrap: break-word;
      white-space: pre-wrap;
      max-height: none !important;
    }

    #htmlInput::placeholder {
      color: #003300;
      opacity: .9;
    }

    .btn-add-part {
      position: absolute;
      bottom: 15px;
      left: 15px;
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--matrix-green);
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s ease;
      font-family: "Arial", sans-serif;
      line-height: 1;
    }

    .btn-add-part:hover {
      color: #fff;
      text-shadow: 0 0 10px var(--matrix-green), 0 0 20px var(--matrix-green);
      transform: scale(1.2);
    }

    .controls {
      margin-top: 14px;
      width: 100%;
      max-width: 560px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      justify-content: center;
    }

    .btn {
      padding: clamp(10px, 3vw, 12px) clamp(16px, 4vw, 24px);
      background: #080808;
      border: 1px solid #222;
      border-radius: 10px;
      cursor: pointer;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 700 !important;
      font-size: clamp(0.9rem, 3.5vw, 1rem);
      color: #bbb;
      transition: all .2s ease;
      width: 100%;
      max-width: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      user-select: none;
    }

    .btn:hover {
      border-color: var(--matrix-green);
      color: var(--matrix-green);
      box-shadow: 0 0 15px rgba(0, 255, 65, .20);
    }

    .btn-clear:hover {
      color: #ff3333;
      border-color: #ff3333;
    }

    .btn-cancel:hover {
      color: #ff6600;
      border-color: #ff6600;
    }

    .controls-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .controls-row-center {
      justify-content: center;
    }


    .pdf-red {
      font-family: "Arial", sans-serif !important;
      color: #D32F2F;
      font-weight: 700 !important;
      letter-spacing: 1px;
      font-size: clamp(0.9rem, 3vw, 1rem);
    }

    .progress-container {
      width: 100%;
      max-width: 560px;
      margin-top: 10px;
      display: none;
    }

    .progress-container.show {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #111;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid #222;
    }

    .progress-fill {
      height: 100%;
      background: var(--matrix-green);
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }

    .progress-text {
      text-align: center;
      margin-top: 6px;
      color: #888;
      font-size: 0.85rem;
      font-family: "IBM Plex Arabic", sans-serif;
    }

    footer {
      width: 100%;
      padding: 8px 14px;
      text-align: center;
      margin-top: auto;
      position: relative;
      bottom: 0;
    }

    .footer-link {
      color: #cfcfcf;
      text-decoration: none;
      font-size: clamp(0.85rem, 3vw, .95rem);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: .3s;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 400 !important;
    }

    .footer-link:hover {
      color: var(--matrix-green);
    }

    .footer-solutions {
      margin-top: 6px;
      color: #8f8f8f;
      font-size: clamp(0.8rem, 2.5vw, .9rem);
      text-decoration: none;
      font-family: "IBM Plex Arabic", sans-serif;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .85);
      z-index: 9999;
      padding: clamp(10px, 3vw, 18px);
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      width: min(720px, 94vw);
      max-height: 86vh;
      overflow: hidden;
      background: #050505;
      border: 1px solid rgba(0, 255, 65, .22);
      border-radius: 14px;
      box-shadow: 0 0 35px rgba(0, 255, 65, .10);
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid #222;
      background: #080808;
      color: #bbb;
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
      z-index: 10;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 400 !important;
    }

    .modal-close:hover {
      border-color: var(--matrix-green);
      color: var(--matrix-green);
    }

    .modal-content {
      padding: 18px 16px 10px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .modal-title {
      margin: 0 0 12px;
      font-size: clamp(1.1rem, 4vw, 1.25rem);
      color: var(--text-white);
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 700 !important;
    }

    .modal-body {
      color: #cfcfcf;
      font-size: clamp(0.9rem, 3.2vw, .98rem);
      line-height: 1.75;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 400 !important;
    }

    .modal-body,
    .modal-body * {
      color: #cfcfcf;
      text-shadow: none;
    }

    .modal-body h3,
    .modal-section-title {
      color: var(--matrix-green);
      text-shadow: none;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 700 !important;
    }

    .modal-title {
      text-shadow: none;
    }

    .modal-box,
    .modal-section {
      color: #cfcfcf;
    }

    .modal-note {
      color: #bdbdbd;
    }

    .modal-quote {
      color: #d8d8d8;
    }

    .modal-link {
      color: var(--matrix-green);
      text-shadow: none;
    }

    .modal-link:hover {
      text-decoration: underline;
    }

    .modal-body h3 {
      margin: 14px 0 8px;
      color: var(--matrix-green);
      font-size: clamp(0.95rem, 3.5vw, 1.05rem);
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 700 !important;
    }

    .modal-body ol,
    .modal-body ul {
      margin: 8px 18px 10px 0;
      padding: 0 18px 0 0;
    }

    .modal-link {
      color: var(--matrix-green);
      text-decoration: none;
      word-break: break-all;
      font-family: "IBM Plex Arabic", sans-serif;
    }

    .modal-link:hover {
      text-decoration: underline;
    }

    .modal-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #080808;
      border: 1px solid #222;
      color: #ddd;
    }

    .modal-quote {
      color: #ddd;
    }

    .modal-section {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #080808;
      border: 1px solid #222;
    }

    .modal-section-title {
      font-weight: 700 !important;
      color: #ddd;
      margin-bottom: 6px;
      font-size: clamp(0.95rem, 3.5vw, 1rem);
      font-family: "IBM Plex Arabic", sans-serif;
    }

    .modal-note {
      margin-top: 8px;
      color: #bdbdbd;
      font-family: "IBM Plex Arabic", sans-serif;
    }

    .modal-ok {
      margin: 10px 16px 16px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #222;
      background: #080808;
      color: #bbb;
      cursor: pointer;
      font-family: "IBM Plex Arabic", sans-serif;
      font-weight: 700 !important;
      font-size: clamp(0.95rem, 3.5vw, 1rem);
    }

    .modal-ok:hover {
      border-color: var(--matrix-green);
      color: var(--matrix-green);
    }

    .bergamot-color {
      color: #2A5F02;
      text-shadow: 0 0 16px rgba(42, 95, 2, .45);
    }

    @media (max-width: 768px) {
      .app {
        min-height: 100vh;
        height: auto;
        padding-bottom: 3cm;
      }

      .main {
        padding: 4px 8px 8px;
      }

      .container {
        padding: 0 8px;
      }

      .matrix-border {
        padding: 8px;
      }

      #htmlInput {
        height: 240px;
        max-height: 45vh;
        min-height: 180px;
        padding: 12px;
        font-size: 12px;
      }

      .controls {
        gap: 8px;
      }

      .controls-row {
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        max-width: 100%;
        padding: 14px 20px;
      }

      .modal {
        width: 95%;
        max-height: 90vh;
      }

      .modal-content {
        padding: 14px 12px 8px;
      }

      .btn-add-part {
        font-size: 20px;
        bottom: 12px;
        left: 12px;
        padding: 4px 10px;
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 15px 10px 10px;
      }

      .bergamot-neon {
        font-size: clamp(1.8rem, 9vw, 2.4rem);
      }

      .title-tech {
        margin-bottom: -6px;
      }

      #htmlInput {
        height: 200px;
        max-height: 40vh;
        min-height: 180px;
        padding: 10px;
        font-size: 11px;
      }

      .btn {
        padding: 12px 16px;
        font-size: 0.9rem;
      }

      .scan-text,
      .pdf-red {
        font-size: 0.9em;
      }

      footer {
        padding: 8px 10px;
      }

      .modal-close {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }

      .btn-add-part {
        font-size: 18px;
        bottom: 10px;
        left: 10px;
        padding: 4px 8px;
      }
    }

    @media (max-width: 768px) {

      input,
      textarea,
      select,
      button {
        font-size: 16px !important;
      }
    }

    @media (max-height: 720px) and (max-width: 768px) {
      header {
        padding: 12px 10px 8px;
      }

      #htmlInput {
        height: clamp(180px, 35vh, 240px);
        max-height: 40vh;
      }

      .btn {
        padding: 10px 16px;
        font-size: .9rem;
      }

      footer {
        padding: 6px 10px;
      }
    }

    @media (max-width: 360px) {
      .bergamot-neon {
        font-size: 1.6rem;
      }

      #htmlInput {
        height: 180px;
        max-height: 38vh;
      }

      .btn {
        padding: 10px 14px;
        font-size: 0.85rem;
      }

      .modal-title {
        font-size: 1rem;
      }

      .modal-body {
        font-size: 0.85rem;
      }
    }

    .footer-disclaimer {
      text-align: center;
      color: #666;
      font-size: 0.95rem;
      margin-top: 10px;
      font-family: "IBM Plex Arabic", sans-serif;
    }

    /* Cover Designer Modal Styles */
    .cover-modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.95);
    }

    .cover-modal-overlay.show {
      display: block;
    }

    .cover-modal-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: #111;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px;
      z-index: 10001;
      border-bottom: 1px solid #333;
    }

    .cover-modal-title {
      color: var(--matrix-green);
      font-size: 1rem;
      font-weight: 700;
    }

    .cover-modal-close {
      background: #ff3333;
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cover-modal-close:hover {
      background: #cc0000;
    }

    .cover-modal-frame {
      position: fixed;
      top: 50px;
      left: 0;
      right: 0;
      bottom: 0;
      border: none;
      width: 100%;
      height: calc(100vh - 50px);
    }

    .cover-ready-icon {
      color: var(--matrix-green);
      margin-right: 8px;
      font-size: 1.2em;
    }

    @media print {
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="code-bg" aria-hidden="true">
    <div class="matrix-container">
      <pre class="code-stream">&lt;!doctype html&gt;
&lt;html lang="ar" dir="rtl"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8" /&gt;
  &lt;meta name="viewport" content="width=device-width,initial-scale=1" /&gt;
  &lt;title&gt;Bergamot Report - تقرير برغموت&lt;/title&gt;
  &lt;style&gt;
    :root{ --bg:#000; --green:#00FF41; --panel:#050505; }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{ margin:0; background:var(--bg); color:var(--green); font-family:"IBM Plex Arabic", "Arial", sans-serif; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .container{ width:100%; max-width:560px; padding:20px; }
    .panel{ background:rgba(5,5,5,.9); border:1px solid rgba(0,255,65,.25); border-radius:12px; padding:14px; }
    textarea{ width:100%; height:300px; background:var(--panel); color:var(--green); border:1px solid rgba(0,255,65,.2); border-radius:8px; padding:12px; font-family:"IBM Plex Arabic", Consolas, monospace; font-size:13px; resize:none; outline:none; }
    .actions{ display:flex; gap:10px; margin-top:12px; }
    .btn{ flex:1; padding:12px; background:#080808; border:1px solid #222; color:#bbb; border-radius:10px; cursor:pointer; font-family:"IBM Plex Arabic", sans-serif; font-weight:700; text-align:center; }
    .btn:hover{ border-color:var(--green); color:var(--green); }
    .btn.pdf{ color:#D32F2F; font-weight:900; }
    header{ text-align:center; margin-bottom:20px; }
    h1{ font-size:3rem; color:#2A5F02; text-shadow:0 0 20px rgba(42,95,2,.6); }
    h1 span.arabic{ color:#00FF41; font-family:"IBM Plex Arabic", sans-serif; }
    .subtitle{ color:#666; font-size:0.9rem; }
    footer{ margin-top:20px; text-align:center; color:#444; font-size:0.9rem; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="container"&gt;
    &lt;header&gt;
      &lt;div class="subtitle"&gt;Bergamot Report - تقرير برغموت&lt;/div&gt;
      &lt;h1&gt;Bergamot &lt;span class="arabic"&gt;برغموت&lt;/span&gt;&lt;/h1&gt;
    &lt;/header&gt;
    &lt;div class="panel"&gt;
      &lt;textarea id="code" placeholder="&gt;_ Enter HTML source code..."&gt;&lt;/textarea&gt;
      &lt;div class="actions"&gt;
        &lt;button class="btn pdf"&gt;Export PDF&lt;/button&gt;
        &lt;button class="btn"&gt;Clear&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;footer&gt;Mortdhad Al-Duhaidhawi - مرتضى الدحيدحاوي ©&lt;/footer&gt;
  &lt;/div&gt;
  &lt;script&gt;
    const config = { title: "Bergamot Report - تقرير برغموت", version: "3.0", lang: "ar" };
    function processReport(){ 
      const code = document.querySelector("#code").value.trim();
      if(!code){ console.log("برغموت: أين الكود؟"); return; }
      console.log("Bergamot Processing:", code.length);
    }
    document.querySelectorAll(".btn")[0].addEventListener("click", processReport);
    document.querySelectorAll(".btn")[1].addEventListener("click", () =&gt; { document.querySelector("#code").value = ""; console.log("برغموت: تم المسح"); });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
    </div>
  </div>

  <div class="app no-print">
    <header>
      <div class="title-tech">صانع تقارير</div>
      <h1 class="bergamot-neon">برغموت</h1>
    </header>

    <div class="main">
      <div class="container">

        <div class="parts-bar" id="partsBar"></div>

        <div class="matrix-border" style="position: relative;">
          <textarea id="htmlInput" placeholder=">_ أدخل كود المصدر هنا..." maxlength="10000000" autocomplete="off"
            autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
          <button class="btn-add-part" onclick="addReportPart()" title="إضافة جزء">+</button>
        </div>

        <div class="controls controls-grid">
          <div class="controls-row">
            <button class="btn btn-scan" id="coverBtn" onclick="openCoverDesigner()">
              <span id="coverReadyIcon" class="cover-ready-icon" style="display:none;">✓</span>
              الواجهة
            </button>

            <button class="btn btn-scan" id="exportBtn" onclick="printReport()">
              تصدير <span class="pdf-red">PDF</span>
            </button>
          </div>

          <div class="controls-row controls-row-center">
            <button class="btn btn-clear" onclick="clearAll()">
              مسح
            </button>

            <button class="btn btn-guide" onclick="openGuideModal()">
              دليل الاستخدام
            </button>
          </div>
        </div>


      </div>
    </div>

    <footer>
      <a href="https://t.me/Mortdh190" target="_blank" class="footer-link">
        مرتضى الدحيدحاوي <span style="font-size:1.2em;">©</span>
      </a>
      <div class="footer-solutions"> </div>
      <div class="footer-disclaimer">غير مبرئ للذمة كل من يستخدم التطبيق لإنتاج تقارير مقابل أجور مادية او
        معنوية</div>
    </footer>
  </div>

  <div id="guideModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <button class="modal-close" type="button" aria-label="إغلاق" onclick="closeGuideModal()">×</button>

      <div class="modal-content">
        <h2 class="modal-title">دليل الاستخدام</h2>

        <div class="modal-body">
          <div class="modal-box">
            <div class="modal-section-title">أولاً: ملف الأوامر (هندسة السياق برغموت)</div>
            <p>قم بتنزيل ملف هندسة السياق برغموت من رابط التلغرام التالي:</p>
            <p><a class="modal-link" href="https://t.me/bergamot_EN_AR/27" rel="noopener"
                target="_blank">https://t.me/bergamot_EN_AR/27</a></p>
            <p>بعد تنزيل الملف، يمكنك استخدام أي تطبيق ذكاء اصطناعي ورفع الملف إليه.</p>
            <p>عند إرسال الملف، اكتب في نفس الرسالة ثلاث معلومات فقط:</p>
            <ul>
              <li>اسم التقرير</li>
              <li>لغة التقرير</li>
              <li>عدد الصفحات</li>
            </ul>

            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px dashed #333;">
              <p style="margin-bottom: 5px;">بعد الإرسال، سيقوم الذكاء الاصطناعي بإعطائك كود HTML جاهز:</p>
              <ol style="padding-right: 20px; line-height: 1.6; color: #cfcfcf;">
                <li>قم بنسخ الكود الأول بالكامل (استخدم زر النسخ).</li>
                <li>اكتب كلمة <span style="color:var(--matrix-green); font-weight:bold;">"أكمل"</span> للذكاء الاصطناعي.
                </li>
                <li>سيرسل لك كوداً آخر، قم بنسخه أيضاً.</li>
                <li>كرر العملية (كل كود يمثل صفحتين) واحرص على النسخ <strong>بالترتيب</strong>.</li>
              </ol>
            </div>
          </div>

          <div class="modal-box">
            <div class="modal-section-title">ثانياً: صانع تقارير برغموت</div>
            <ol style="padding-right: 20px; line-height: 1.8; margin-bottom: 10px;">
              <li>ألصق كل كود HTML نسخته في المربع المكتوب عليه: <span style="color:#888;">"أدخل كود المصدر هنا"</span>.
              </li>
              <li>اضغط على زر <span
                  style="color:var(--matrix-green); font-weight:bold; font-size:1.4em; vertical-align: middle;">+</span>
                الأخضر (أسفل يسار المربع) لإضافة الجزء.</li>
              <li>كرر العملية لكل الأكواد بالترتيب.</li>
              <li>عند اكتمال جميع الصفحات، اضغط زر <span class="pdf-red" style="font-weight:bold;">تصدير PDF</span>.
              </li>
            </ol>
            <p class="modal-note"
              style="font-size: 0.9em; border-right: 3px solid var(--matrix-green); padding-right: 8px;">
              ملاحظة: إذا كان تقريرك يتكون من عدد فردي (مثلاً 7 صفحات)، فلا تقلق؛ الكود الأخير سيكون صفحة واحدة (المصادر
              فقط).
            </p>
          </div>


        </div>

        <button class="modal-ok" type="button" onclick="closeGuideModal()">موافق</button>
      </div>
    </div>
  </div>

  <!-- Cover Designer Modal -->
  <div id="coverModal" class="cover-modal-overlay">
    <div class="cover-modal-header">
      <span class="cover-modal-title">صفحة الواجهة</span>
      <button class="cover-modal-close" onclick="closeCoverDesigner()">×</button>
    </div>
    <iframe id="coverDesignerFrame" class="cover-modal-frame"></iframe>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════ -->
  <!-- الصق كود مصمم الغلاف الأصلي الكامل داخل textarea أدناه بدلاً من النص الموجود -->
  <!-- لا تعدّل أي شيء آخر - الكود سيتعدّل تلقائياً عند التشغيل                      -->
  <!-- ═══════════════════════════════════════════════════════════════════════════ -->
  <textarea id="cover-designer-code" style="display:none;"><!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مصمم غلاف التقارير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri&family=Cairo:wght@400;700&family=El+Messiri&family=Lalezar&family=Lateef&family=Lobster&family=Montserrat&family=Noto+Naskh+Arabic:wght@400;700&family=Oswald&family=Tajawal&family=Times+New+Roman&display=swap"
        rel="stylesheet">
    <style>
        @page {
            size: A4;
            margin: 0;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #7f8c8d;
            --text-color: #34495e;
            --border-color: #bdc3c7;
            --hover-color: #d5dbdb;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --page-width: 210mm;
            --page-height: 297mm;
            --page-height-print: 297mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            overflow-x: hidden;
            height: 100%;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.7;
            overflow-x: hidden;
            height: 100%;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .zoom-container {
            flex-grow: 1;
            overflow: auto;
            display: flex;
            align-items: flex-start;
            /* justify-content: center; REMOVED to allow scrolling overflow */
            padding: 20px;
            background-color: #7f8c8d;
            touch-action: pan-x pan-y pinch-zoom;
            -webkit-overflow-scrolling: touch;
            position: relative;
            width: 100%;
            /* direction: ltr; REMOVED - using RTL default */
        }

        .zoom-content {
            transition: width 0.1s ease-out, height 0.1s ease-out;
            margin: auto;
            /* Centers content when smaller than viewport */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-shrink: 0;
            overflow: visible;
            /* min-width/height removed to allow JS sizing */
        }

        .toolbar {
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            justify-content: center;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding: 0 0.5rem;
            border-left: 1px solid var(--border-color);
            align-items: center;
            position: relative;
        }

        .toolbar-group:first-child {
            border-left: none;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            border-radius: 5px;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            transition: all 0.2s ease;
        }

        .toolbar-btn.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .toolbar-btn:hover:not(.active) {
            background-color: var(--hover-color);
        }

        .toolbar-select {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: white;
            color: var(--text-color);
        }

        #cover-page-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 0 auto;
            padding: 0;
            box-sizing: border-box;
            padding-bottom: 100px;
            padding: 20px;
        }

        /* الإعداد الافتراضي للصفحة */
        #cover-page {
            width: var(--page-width);
            height: var(--page-height);
            padding: 15mm;
            box-sizing: border-box;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1), 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            page-break-after: always;
            page-break-inside: avoid;
            flex-shrink: 0;
            margin: 0 auto;
            border: none;
            transition: all 0.3s ease;
        }

        /* الإطارات الداخلية - داخل الصفحة قرب الحدود */
        .frame-style-1::before,
        .frame-style-2::before,
        .frame-style-3::before,
        .frame-style-4::before,
        .frame-style-5::before,
        .frame-style-6::before,
        .frame-style-7::before,
        .frame-style-8::before,
        .frame-style-9::before,
        .frame-style-10::before,
        .frame-style-11::before,
        .frame-style-12::before,
        .frame-style-13::before,
        .frame-style-14::before,
        .frame-style-15::before,
        .frame-style-16::before,
        .frame-style-17::before,
        .frame-style-18::before,
        .frame-style-19::before {
            content: '';
            position: absolute;
            top: 6mm;
            left: 6mm;
            right: 6mm;
            bottom: 6mm;
            pointer-events: none;
            z-index: 10;
            box-sizing: border-box;
            display: block !important;
        }

        /* الإطارات الحالية (1-15) */
        .frame-style-1::before {
            border: 5px solid #000000;
        }

        .frame-style-2::before {
            border: 6px double #2c3e50;
        }

        .frame-style-3::before {
            border: 4px dashed #34495e;
        }

        .frame-style-4::before {
            border: 5px dotted #2c3e50;
        }

        .frame-style-5::before {
            border: 6px groove #3498db;
        }

        .frame-style-6::before {
            border: 6px ridge #e74c3c;
        }

        .frame-style-7::before {
            border: 5px inset #8e44ad;
        }

        .frame-style-8::before {
            border: 5px outset #27ae60;
        }

        .frame-style-9::before {
            border-top: 5px solid #e74c3c;
            border-bottom: 5px solid #e74c3c;
            border-left: 5px dashed #3498db;
            border-right: 5px dashed #3498db;
        }

        .frame-style-10::before {
            border: 6px solid #2c3e50;
            border-radius: 15px;
        }

        .frame-style-11::before {
            border: 8px double #2c3e50;
            box-shadow: inset 0 0 0 2px #f1c40f;
        }

        .frame-style-12::before {
            border-top: 5px dashed #e67e22;
            border-right: 5px dotted #9b59b6;
            border-bottom: 5px dashed #e67e22;
            border-left: 5px dotted #9b59b6;
        }

        .frame-style-13::before {
            border: 4px solid #2c3e50;
            box-shadow: 0 0 0 4px #fff, 0 0 0 8px #3498db;
        }

        .frame-style-14::before {
            border: 6px solid #2c3e50;
            border-image: linear-gradient(to bottom right, #3498db, #2ecc71, #f1c40f, #e74c3c) 1;
        }

        .frame-style-15::before {
            border: 5px solid transparent;
            border-top-color: #e74c3c;
            border-bottom-color: #e74c3c;
            border-left-color: #3498db;
            border-right-color: #3498db;
            border-radius: 20px;
        }

        /* الإطارات القديمة المستعادة (16-19) */
        .frame-style-16::before {
            border: 8px solid transparent;
            border-image: linear-gradient(45deg, #2c3e50, #3498db, #2c3e50) 1;
        }

        .frame-style-17::before {
            border: 8px solid transparent;
            border-image: linear-gradient(45deg, #e74c3c, #f39c12, #e74c3c) 1;
        }

        .frame-style-18::before {
            border: 8px solid transparent;
            border-image: linear-gradient(45deg, #3498db, #9b59b6, #3498db) 1;
        }

        .frame-style-19::before {
            border: 5px solid #27ae60;
            box-shadow: inset 0 0 0 3px #fff, inset 0 0 0 6px #27ae60;
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .zoom-container {
                background: white;
                padding: 0;
                overflow: visible;
                display: block;
            }

            .zoom-content {
                transform: none !important;
                margin: 0;
            }

            #cover-page-wrapper {
                margin: 0;
                padding: 0;
            }

            #cover-page {
                height: var(--page-height-print);
                box-shadow: none;
                page-break-after: always;
                break-inside: avoid;
                margin: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* إظهار جميع الإطارات عند الطباعة */
            .frame-style-1::before,
            .frame-style-2::before,
            .frame-style-3::before,
            .frame-style-4::before,
            .frame-style-5::before,
            .frame-style-6::before,
            .frame-style-7::before,
            .frame-style-8::before,
            .frame-style-9::before,
            .frame-style-10::before,
            .frame-style-11::before,
            .frame-style-12::before,
            .frame-style-13::before,
            .frame-style-14::before,
            .frame-style-15::before,
            .frame-style-16::before,
            .frame-style-17::before,
            .frame-style-18::before,
            .frame-style-19::before {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .toolbar,
            .external-controls {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .zoom-container {
                padding: 10px;
                padding-top: 5px;
                /* Minimal top padding */
                align-items: flex-start;
            }

            #cover-page {
                box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1), 0 2px 10px rgba(0, 0, 0, 0.2);
            }

            .zoom-content {
                width: 100%;
                display: flex;
                justify-content: center;
                margin: 0 auto;
                /* Remove top margin on mobile */
            }
        }

        #cover-page.ltr {
            direction: ltr;
        }

        #cover-page.ltr #cover-page-header {
            flex-direction: row-reverse;
        }

        #cover-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 40px;
            position: relative;
            min-height: 200px;
            width: 100%;
            overflow: visible;
        }

        .uni-info {
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 20px;
        }

        #cover-page.ltr .uni-info {
            font-weight: bold;
            text-align: right;
        }

        .uni-info .editable {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.4;
            margin: 5px 0;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #cover-uni-name {
            order: 1;
        }

        #cover-faculty-name {
            order: 2;
        }

        main {
            text-align: center;
        }

        .report-title {
            font-size: 32px;
            font-weight: 700;
            margin-top: 100px; /* Increased from 80px */
            margin-bottom: 80px; /* Increased from 60px */
            line-height: 1.3;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            color: #000;
        }

        .supervisor-section {
            margin-top: 80px; /* Increased from 60px */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Increased gap */
        }

        .supervisor-label {
            font-size: 18px;
            color: #000;
            font-weight: bold;
        }

        .supervisor-name {
            font-size: 20px;
            font-weight: 700;
            color: #000;
        }

        .report-section {
            margin-top: 80px; /* Increased from 60px */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .report-label {
            font-size: 18px;
            color: #000;
            font-weight: bold;
        }

        .student-name {
            font-size: 20px;
            font-weight: 700;
            color: #000;
        }

        .stage-info {
            margin-top: 70px; /* Reduced from 100px */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .stage-label {
            font-size: 18px;
            color: #000;
            font-weight: bold;
        }

        .stage-name {
            font-size: 20px;
            font-weight: 700;
            color: #000;
        }

        .editable {
            padding: 5px;
            border: 1px dashed transparent;
            transition: all 0.3s;
            position: relative;
            outline: none;
            cursor: text;
            font-weight: bold;
            user-select: text;
            -webkit-user-select: text;
        }

        .editable:focus {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .editable.cover-line-target {
            background-color: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
        }

        .logo-circle {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            background: #fff;
            border: 2px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            z-index: 5;
            user-select: none;
            -webkit-user-select: none;
            will-change: transform;
            transform: translateZ(0);
            width: 100px;
            height: 100px;
            touch-action: none;
        }

        .logo-circle.image-loaded {
            cursor: default;
            border-style: solid;
            background: transparent;
        }

        .logo-circle.locked {
            cursor: default;
        }

        .logo-circle .img-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 50%;
            display: none;
        }

        .logo-circle.image-loaded .img-container {
            display: block;
        }

        .logo-circle .img-container img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
            -webkit-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        .external-controls {
            position: fixed;
            display: none;
            gap: 10px;
            z-index: 1000;
            padding: 8px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .external-controls.show {
            display: flex;
        }

        .external-controls.locked {
            display: none !important;
        }

        .ext-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            touch-action: none;
        }

        .ext-control-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .ext-control-btn:active {
            transform: scale(0.95);
        }

        .logo-circle.active {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.3);
            z-index: 50;
        }

        .color-dropdown,
        .frame-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            width: 280px;
        }

        /* Lean frame dropdown to the left */
        #cover-frame-dropdown {
            transform: translateX(-70%);
        }

        /* Lean cover color dropdown 2cm to left */
        #cover-color-dropdown {
            margin-left: -2cm;
        }

        #cover-color-dropdown::before {
            margin-left: 2cm;
        }

        .color-dropdown::before,
        .frame-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #fff;
        }

        /* Adjust frame dropdown arrow */
        #cover-frame-dropdown::before {
            left: 70%;
        }

        .color-palette-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .color-swatch:hover {
            transform: scale(1.15);
        }

        /* شبكة الإطارات - 5 أعمدة */
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 5px;
        }

        .frame-item {
            width: 42px;
            height: 52px;
            background: #f9f9f9;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #666;
        }

        .frame-item:hover {
            transform: scale(1.15);
            z-index: 5;
            background: #fff;
        }

        /* أنماط العينات (1-15) */
        .frame-item.frame-style-0 {
            border: 1px dashed #ccc;
            color: #999;
            background: #fff;
        }

        .frame-item.frame-style-1 {
            border: 3px solid #000000;
        }

        .frame-item.frame-style-2 {
            border: 4px double #2c3e50;
        }

        .frame-item.frame-style-3 {
            border: 3px dashed #34495e;
        }

        .frame-item.frame-style-4 {
            border: 3px dotted #2c3e50;
        }

        .frame-item.frame-style-5 {
            border: 4px groove #3498db;
        }

        .frame-item.frame-style-6 {
            border: 4px ridge #e74c3c;
        }

        .frame-item.frame-style-7 {
            border: 3px inset #8e44ad;
        }

        .frame-item.frame-style-8 {
            border: 3px outset #27ae60;
        }

        .frame-item.frame-style-9 {
            border-top: 3px solid #e74c3c;
            border-bottom: 3px solid #e74c3c;
            border-left: 3px dashed #3498db;
            border-right: 3px dashed #3498db;
        }

        .frame-item.frame-style-10 {
            border: 4px solid #2c3e50;
            border-radius: 8px;
        }

        .frame-item.frame-style-11 {
            border: 5px double #2c3e50;
            box-shadow: inset 0 0 0 1px #f1c40f;
        }

        .frame-item.frame-style-12 {
            border-top: 3px dashed #e67e22;
            border-right: 3px dotted #9b59b6;
            border-bottom: 3px dashed #e67e22;
            border-left: 3px dotted #9b59b6;
        }

        .frame-item.frame-style-13 {
            border: 3px solid #2c3e50;
            box-shadow: 0 0 0 2px #fff, 0 0 0 3px #3498db;
        }

        .frame-item.frame-style-14 {
            border: 4px solid #2c3e50;
            border-image: linear-gradient(to bottom right, #3498db, #2ecc71) 1;
        }

        .frame-item.frame-style-15 {
            border: 3px solid transparent;
            border-top-color: #e74c3c;
            border-bottom-color: #e74c3c;
            border-left-color: #3498db;
            border-right-color: #3498db;
            border-radius: 10px;
        }

        /* أنماط العينات القديمة المستعادة (16-19) */
        .frame-item.frame-style-16 {
            border: 4px solid transparent;
            border-image: linear-gradient(45deg, #2c3e50, #3498db) 1;
        }

        .frame-item.frame-style-17 {
            border: 4px solid transparent;
            border-image: linear-gradient(45deg, #e74c3c, #f39c12) 1;
        }

        .frame-item.frame-style-18 {
            border: 4px solid transparent;
            border-image: linear-gradient(45deg, #3498db, #9b59b6) 1;
        }

        .frame-item.frame-style-19 {
            border: 3px solid #27ae60;
            box-shadow: inset 0 0 0 1px #fff, inset 0 0 0 2px #27ae60;
        }



        .circles-menu-header {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            text-align: center;
            background: #f8f9fa;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .circle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 32px;
            gap: 4px;
        }

        .circle-item:hover {
            background: var(--hover-color);
        }

        .circle-item.active {
            background: rgba(52, 152, 219, 0.15);
            border-right: 3px solid var(--secondary-color);
        }

        .circle-item-info {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .circle-item-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .circle-item-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .circle-item-preview i {
            font-size: 8px;
            color: #999;
        }

        .circle-item-name {
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            line-height: 1.2;
        }

        .circle-item-delete {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            padding: 2px 3px;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 9px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
        }

        .circle-item-delete:hover {
            background: rgba(231, 76, 60, 0.1);
        }

        .add-circle-option {
            padding: 6px;
            text-align: center;
            color: var(--secondary-color);
            cursor: pointer;
            border-top: 1px dashed var(--border-color);
            font-weight: bold;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 10px;
            margin-top: 2px;
        }

        .add-circle-option:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .dropdown-container {
            position: relative;
        }

        .empty-state {
            padding: 6px;
            text-align: center;
            color: #999;
            font-size: 9px;
            line-height: 1.3;
        }

        .circles-menu {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            left: -15px;
            /* Shift slightly left */
            right: auto;
            transform: none;
            /* Remove the centering transform */
            width: 95px;
            /* Even narrower */
            padding: 4px 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1002;
            max-height: 250px;
            overflow-y: auto;
        }

        .circles-menu.show {
            display: block;
        }

        .circles-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 35px;
            /* Adjusted for left: -15px on menu */
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .circle-item {
            padding: 2px 4px;
            /* Slight horizontal padding */
            gap: 0;
            /* Remove gap */
            min-height: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Push delete btn to end, or use flex-start if we want them close */
        }

        .circle-item-info {
            gap: 2px;
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
        }

        .circle-item-name {
            font-size: 8px;
            /* Smaller font */
            line-height: 1.2;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 2px;
        }

        .circle-item-delete {
            width: 14px;
            height: 14px;
            padding: 0;
            margin: 0;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .circle-item-preview {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 50%;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="toolbar">
            <div class="toolbar-group">
                <select id="cover-font-family-select" class="toolbar-select" style="width: 150px;">
                    <option style="font-family: Cairo;" value="Cairo" selected>Cairo</option>
                    <option style="font-family: Amiri;" value="Amiri">Amiri</option>
                    <option style="font-family: 'Noto Naskh Arabic';" value="Noto Naskh Arabic">Noto Naskh</option>
                    <option style="font-family: Tajawal;" value="Tajawal">Tajawal</option>
                    <option style="font-family: El Messiri;" value="El Messiri">El Messiri</option>
                    <option style="font-family: Lalezar;" value="Lalezar">Lalezar (فني)</option>
                    <option style="font-family: Arial;" value="Arial">Arial</option>
                    <option style="font-family: 'Times New Roman';" value="Times New Roman">Times New Roman</option>
                    <option style="font-family: Oswald;" value="Oswald">Oswald</option>
                    <option style="font-family: Montserrat;" value="Montserrat">Montserrat</option>
                    <option style="font-family: Lobster;" value="Lobster">Lobster (فني)</option>
                </select>
                <select id="cover-font-size-select" class="toolbar-select">
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18" selected>18</option>
                    <option value="20">20</option>
                    <option value="22">22</option>
                    <option value="24">24</option>
                    <option value="28">28</option>
                    <option value="32">32</option>
                    <option value="36">36</option>
                    <option value="48">48</option>
                    <option value="72">72</option>
                </select>
            </div>
            <div class="toolbar-group">
                <button class="toolbar-btn" data-cover-command="bold" title="تضخيم"><i
                        class="fa-solid fa-bold"></i></button>
                <button class="toolbar-btn" data-cover-command="italic" title="مائل"><i
                        class="fa-solid fa-italic"></i></button>
                <button class="toolbar-btn" data-cover-command="underline" title="تسطير"><i
                        class="fa-solid fa-underline"></i></button>
            </div>
            <div class="toolbar-group">
                <select id="cover-padding-select" class="toolbar-select">
                    <option value="20mm">هامش 2 سم</option>
                    <option value="15mm" selected>هامش 1.5 سم</option>
                    <option value="10mm">هامش 1 سم</option>
                    <option value="5mm">هامش 0.5 سم</option>
                </select>
            </div>
            <div class="toolbar-group" id="cover-color-picker-group">
                <button id="cover-color-btn" class="toolbar-btn" title="لون النص"><i
                        class="fa-solid fa-palette"></i></button>
                <div id="cover-color-dropdown" class="color-dropdown">
                    <div id="cover-color-palette-grid" class="color-palette-grid"></div>
                </div>
            </div>
            <div class="toolbar-group" id="frame-picker-group">
                <button id="cover-frame-btn" class="toolbar-btn" title="إطار الصفحة"><i
                        class="fa-regular fa-square"></i></button>
                <div id="cover-frame-dropdown" class="frame-dropdown">
                    <div id="frame-grid" class="frame-grid"></div>
                </div>
            </div>
            <div class="toolbar-group">
                <button id="cover-save-btn" class="toolbar-btn" title="حفظ الغلاف"><i
                        class="fa-solid fa-save"></i></button>
                <button id="cover-toggle-layout" class="toolbar-btn" title="تبديل اتجاه الواجهة"><i
                        class="fa-solid fa-arrows-left-right"></i></button>
            </div>
            <div class="toolbar-group">
                <div class="dropdown-container">
                    <button id="manage-circles-btn" class="toolbar-btn" title="إدارة الشعارات"><i
                            class="fa-solid fa-university"></i></button>
                    <div id="circles-menu" class="circles-menu">
                        <div class="circles-menu-header">الشعارات</div>
                        <div id="circles-list">
                            <div class="empty-state">لا توجد شعارات مضافة<br>اضغط + لإضافة شعار</div>
                        </div>
                        <div class="add-circle-option" id="add-new-circle">
                            <i class="fa-solid fa-plus"></i> إضافة شعار جديد
                        </div>
                    </div>
                </div>
                <button id="active-lock-btn" class="toolbar-btn" title="قفل/فتح الدائرة" style="display:none;"><i
                        class="fa-solid fa-lock-open"></i></button>
                <button id="active-delete-img-btn" class="toolbar-btn" title="حذف الصورة"
                    style="display:none; color: #e74c3c;"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>

        <div class="zoom-container" id="zoom-container">
            <div class="zoom-content" id="zoom-content">
                <div id="cover-page-wrapper">
                    <div id="cover-page" class="a4">
                        <header id="cover-page-header">
                            <div id="circles-container"></div>
                            <div class="uni-info">
                                <div id="cover-uni-name" class="editable" contenteditable="true" spellcheck="false">
                                    جامعة الكوفة</div>
                                <div id="cover-faculty-name" class="editable" contenteditable="true" spellcheck="false">
                                    كلية العلوم - قسم البيئة والتلوث</div>
                            </div>
                        </header>
                        <main>
                            <h1 id="cover-report-title" class="editable report-title" contenteditable="true"
                                spellcheck="false">اكتب عنوان التقرير هنا</h1>

                            <div class="supervisor-section">
                                <div id="cover-supervisor-label" class="editable supervisor-label"
                                    contenteditable="true" spellcheck="false">إشراف</div>
                                <div id="cover-supervisor-name" class="editable supervisor-name" contenteditable="true"
                                    spellcheck="false">د. اكتب اسم المشرف</div>
                            </div>

                            <div class="report-section">
                                <div id="cover-report-label" class="editable report-label" contenteditable="true"
                                    spellcheck="false">تقرير</div>
                                <div id="cover-student-name" class="editable student-name" contenteditable="true"
                                    spellcheck="false">اسم الطالب/ة</div>
                            </div>

                            <div class="stage-info">
                                <div id="cover-stage-label" class="editable stage-label" contenteditable="true" spellcheck="false">المرحلة</div>
                                <div id="cover-stage-name" class="editable stage-name" contenteditable="true" spellcheck="false">
                                    أولى - ثانية - ثالثة - رابعة - صباحي / مسائي</div>
                            </div>
                        </main>
                    </div>
                </div>
            </div>
        </div>

        <div class="external-controls" id="external-controls">
            <button class="ext-control-btn resize-btn" id="ext-resize-btn" title="تكبير/تصغير الدائرة"><i
                    class="fa-solid fa-expand"></i></button>
            <button class="ext-control-btn drag-btn" id="ext-drag-btn" title="تحريك الدائرة"><i
                    class="fa-solid fa-up-down-left-right"></i></button>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const coverPage = document.getElementById('cover-page');
        const coverHeader = document.getElementById('cover-page-header');
        const circlesContainer = document.getElementById('circles-container');
        const manageCirclesBtn = document.getElementById('manage-circles-btn');
        const circlesMenu = document.getElementById('circles-menu');
        const circlesList = document.getElementById('circles-list');
        const addNewCircleBtn = document.getElementById('add-new-circle');
        const activeLockBtn = document.getElementById('active-lock-btn');
        const activeDeleteImgBtn = document.getElementById('active-delete-img-btn');
        const coverSaveBtn = document.getElementById('cover-save-btn');
        const coverToggleLayoutBtn = document.getElementById('cover-toggle-layout');
        const coverFontFamilySelect = document.getElementById('cover-font-family-select');
        const coverFontSizeSelect = document.getElementById('cover-font-size-select');
        const coverPaddingSelect = document.getElementById('cover-padding-select');
        const coverColorBtn = document.getElementById('cover-color-btn');
        const coverColorDropdown = document.getElementById('cover-color-dropdown');
        const coverFrameBtn = document.getElementById('cover-frame-btn');
        const coverFrameDropdown = document.getElementById('cover-frame-dropdown');
        const zoomContainer = document.getElementById('zoom-container');
        const zoomContent = document.getElementById('zoom-content');
        const coverPageWrapper = document.getElementById('cover-page-wrapper'); // Added variable
        const externalControls = document.getElementById('external-controls');

        let circles = [];
        let activeCircleId = null;
        let circleCounter = 0;
        const COVER_STORAGE_KEY = 'cover_design_data_v2';
        const EXPORT_SCALE = 3;

        let pageScale = 1;
        let minPageScale = 0.5;
        // let panX = 0; // Removed
        // let panY = 0; // Removed
        let isPinching = false;
        // let isPanning = false; // Removed
        // let lastTouchX = 0; // Removed
        // let lastTouchY = 0; // Removed
        let initialPinchDistance = 0;
        let initialScale = 1;

        let currentCircleData = null;
        let isDragging = false;
        let isResizing = false;
        let dragStartX, dragStartY, dragInitialLeft, dragInitialTop;
        let resizeStartDistance, resizeStartSize;

        const colorPalette = [
          '#FF0000', '#1976d2', '#388e3c', '#fbc02d', '#000000',
          '#f57c00', '#7b1fa2', '#c2185b', '#512da8', '#303f9f',
          '#0288d1', '#0097a7', '#00796b', '#689f38', '#afb42b',
          '#ffa000', '#e64a19', '#5d4037', '#616161', '#455a64', '#4B0082'
        ];

        const colorPickerGridEl = document.getElementById('cover-color-palette-grid');
        colorPalette.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.background = color;
          swatch.addEventListener('click', (e) => {
            e.stopPropagation();
            applyColorToSelection(color);
            coverColorDropdown.style.display = 'none';
          });
          colorPickerGridEl.appendChild(swatch);
        });

        // جميع الإطارات (15 الحالية + 4 القديمة المستعادة)
        const frameClasses = [
          'frame-style-0', 'frame-style-1', 'frame-style-2', 'frame-style-3',
          'frame-style-4', 'frame-style-5', 'frame-style-6', 'frame-style-7',
          'frame-style-8', 'frame-style-9', 'frame-style-10', 'frame-style-11',
          'frame-style-12', 'frame-style-13', 'frame-style-14', 'frame-style-15',
          'frame-style-16', 'frame-style-17', 'frame-style-18', 'frame-style-19'
        ];

        const frameGridEl = document.getElementById('frame-grid');
        const frameDescriptions = [
          'بدون', 'سميك أسود', 'مزدوج', 'متقطع', 'منقط', 'منقوش',
          'بارز', 'غائر', 'بارز خارجي', 'مزيج ألوان', 'زوايا دائرية',
          'مزدوج ملون', 'متقطع-منقط', 'ظلال', 'متدرج', 'زوايا ملونة',
          'تدرج أزرق', 'تدرج حراري', 'تدرج بنفسجي', 'أخضر مزدوج'
        ];

        frameClasses.forEach((frameClass, index) => {
          const frameItem = document.createElement('div');
          frameItem.className = `frame-item ${frameClass}`;
          frameItem.title = frameDescriptions[index];

          if (index === 0) {
            frameItem.innerHTML = '<span>بدون</span>';
            frameItem.style.border = '1px dashed #ccc';
            frameItem.style.color = '#666';
            frameItem.style.background = '#fff';
          }

          frameItem.addEventListener('click', (e) => {
            e.stopPropagation();
            applyFrame(frameClass);
            coverFrameDropdown.style.display = 'none';
          });
          frameGridEl.appendChild(frameItem);
        });

        function applyFrame(frameClass) {
          frameClasses.forEach(fc => {
            if (fc !== 'frame-style-0') {
              coverPage.classList.remove(fc);
            }
          });

          if (frameClass !== 'frame-style-0') {
            coverPage.classList.add(frameClass);
          }

          debouncedSaveCoverState();
        }

        function applyColorToSelection(color) {
          const activeEl = document.querySelector('.editable.cover-line-target') ||
            document.activeElement.closest('.editable');
          if (activeEl) {
            activeEl.style.color = color;
            debouncedSaveCoverState();
          }
        }

        let saveTimeout;
        function debouncedSaveCoverState() {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveCoverState, 500);
        }

        function adjustPageDisplay() {
          const containerWidth = zoomContainer.clientWidth;
          const pageWidth = coverPage.offsetWidth; // Base width without scale
          // Leave some margin
          const availableWidth = containerWidth - 40;

          let fitScale = availableWidth / pageWidth;
          if (fitScale > 1) fitScale = 1; // Optional: don't auto-zoom larger than 100% initially

          minPageScale = 0.3;
          pageScale = fitScale;

          updateTransform();
        }

        function updateTransform() {
          // Determine the base size from the wrapper's layout size
          // We assume coverPageWrapper has the correct intrinsic size (approx A4 + padding)
          const baseWidth = coverPageWrapper.offsetWidth;
          const baseHeight = coverPageWrapper.offsetHeight;

          // Set the container size to the SCALED size
          // This forces the scroll container to provide scrollbars for the full visual area
          zoomContent.style.width = `${baseWidth * pageScale}px`;
          zoomContent.style.height = `${baseHeight * pageScale}px`;

          // Center alignment handled by zoomContent CSS margin:auto (centering in container)
          // and justify-content: center (centering the wrapper inside the expanded zoomContent)

          // Scale the inner wrapper
          // Transform origin top center ensures it expands downwards and symmetrically horizontally
          coverPageWrapper.style.transform = `scale(${pageScale})`;
          coverPageWrapper.style.transformOrigin = 'top center';

          // Clear any legacy styles on zoomContent
          zoomContent.style.transform = '';
          zoomContent.style.transformOrigin = '';
          zoomContent.style.marginBottom = '';

          if (activeCircleId && currentCircleData && !currentCircleData.locked) {
            updateExternalControlsPosition();
          }
        }

        window.addEventListener('load', adjustPageDisplay);
        window.addEventListener('resize', adjustPageDisplay);

        setupAdvancedZoom();

        function setupAdvancedZoom() {
          // We only handle pinch-to-zoom and Ctrl+Wheel. 
          // Panning is handled natively by the browser's overflow: auto.

          zoomContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
              isPinching = true;
              initialPinchDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
              );
              initialScale = pageScale;
            }
          }, { passive: true });

          zoomContainer.addEventListener('touchmove', (e) => {
            if (isPinching && e.touches.length === 2) {
              e.preventDefault(); // Prevent native browser zoom
              const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
              );
              const delta = dist / initialPinchDistance;
              pageScale = Math.max(minPageScale, Math.min(4.0, initialScale * delta));
              updateTransform();
            }
          }, { passive: false });

          zoomContainer.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) {
              isPinching = false;
            }
          });

          zoomContainer.addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              const delta = e.deltaY > 0 ? 0.9 : 1.1;
              pageScale = Math.max(minPageScale, Math.min(4.0, pageScale * delta));
              updateTransform();
            }
          }, { passive: false });

          // Double tap/click to reset fitting
          zoomContainer.addEventListener('dblclick', (e) => {
            if (e.target === zoomContainer || e.target === zoomContent) {
              adjustPageDisplay();
            }
          });
        }

        function createCircle() {
          circleCounter++;
          const circleId = `circle-${circleCounter}`;
          const size = 100;

          const existingCount = circles.length;
          const isRight = existingCount % 2 === 0;
          const defaultLeft = isRight ?
            coverHeader.clientWidth - size - 20 : 20;
          const defaultTop = 20 + (Math.floor(existingCount / 2) * 20);

          const circle = document.createElement('div');
          circle.id = circleId;
          circle.className = 'logo-circle';
          circle.style.width = size + 'px';
          circle.style.height = size + 'px';
          circle.style.left = defaultLeft + 'px';
          circle.style.top = defaultTop + 'px';

          circle.innerHTML = `
                    <i class="fa-solid fa-image placeholder-icon"></i>
                    <div class="img-container" id="${circleId}-img-container">
                        <img id="${circleId}-img" src="" alt="" draggable="false" />
                    </div>
                    <input type="file" id="${circleId}-input" accept="image/*" style="display:none;" />
                `;

          circlesContainer.appendChild(circle);

          const circleData = {
            id: circleId,
            element: circle,
            hasImage: false,
            locked: false,
            x: defaultLeft,
            y: defaultTop,
            size: size,
            imgScale: 1,
            imgOffsetX: 0,
            imgOffsetY: 0
          };

          circles.push(circleData);
          setupCircleEvents(circleData);
          setActiveCircle(circleId);
          updateCirclesMenu();

          circlesMenu.classList.remove('show');

          return circleData;
        }

        function setupCircleEvents(circleData) {
          const circle = circleData.element;
          const input = document.getElementById(`${circleData.id}-input`);
          const img = document.getElementById(`${circleData.id}-img`);
          const imgContainer = document.getElementById(`${circleData.id}-img-container`);

          circle.addEventListener('click', (e) => {
            e.stopPropagation();
            if (isDragging || isResizing) return;

            setActiveCircle(circleData.id);

            if (!circleData.hasImage && !circleData.locked) {
              input.click();
            }
          });

          input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
              alert('يرجى اختيار صورة صالحة');
              return;
            }

            const reader = new FileReader();
            reader.onload = (ev) => {
              img.src = ev.target.result;
              circle.classList.add('image-loaded');
              circleData.hasImage = true;
              circleData.imgScale = 1;
              circleData.imgOffsetX = 0;
              circleData.imgOffsetY = 0;
              updateImageTransform(circleData);

              updateCirclesMenu();
              updateActiveButtons();
              debouncedSaveCoverState();
            };
            reader.readAsDataURL(file);
          });

          setupImageEdit(circleData, imgContainer);
        }

        function updateImageTransform(circleData) {
          const img = document.getElementById(`${circleData.id}-img`);
          if (img) {
            img.style.transform = `translate(-50%, -50%) translate(${circleData.imgOffsetX}px, ${circleData.imgOffsetY}px) scale(${circleData.imgScale})`;
          }
        }

        function setupExternalDragEvents() {
          const dragBtn = document.getElementById('ext-drag-btn');

          dragBtn.addEventListener('mousedown', startDrag);
          dragBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startDrag(e.touches[0]);
          }, { passive: false });
        }

        function startDrag(e) {
          if (!currentCircleData || currentCircleData.locked) return;

          isDragging = true;
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          dragInitialLeft = currentCircleData.element.offsetLeft;
          dragInitialTop = currentCircleData.element.offsetTop;

          document.addEventListener('mousemove', doDrag);
          document.addEventListener('touchmove', doDrag, { passive: false });
          document.addEventListener('mouseup', endDrag);
          document.addEventListener('touchend', endDrag);
        }

        function doDrag(e) {
          if (!isDragging || !currentCircleData) return;
          e.preventDefault();

          const clientX = e.clientX || (e.touches && e.touches[0].clientX);
          const clientY = e.clientY || (e.touches && e.touches[0].clientY);

          if (!clientX || !clientY) return;

          const dx = (clientX - dragStartX) / pageScale;
          const dy = (clientY - dragStartY) / pageScale;

          let newLeft = dragInitialLeft + dx;
          let newTop = dragInitialTop + dy;

          const maxX = coverHeader.clientWidth - currentCircleData.element.offsetWidth;
          const maxY = coverHeader.clientHeight - currentCircleData.element.offsetHeight;

          newLeft = Math.max(-50, Math.min(newLeft, maxX + 50));
          newTop = Math.max(-50, Math.min(newTop, maxY + 50));

          currentCircleData.element.style.left = newLeft + 'px';
          currentCircleData.element.style.top = newTop + 'px';
          currentCircleData.x = newLeft;
          currentCircleData.y = newTop;

          updateExternalControlsPosition();
        }

        function endDrag() {
          if (!isDragging) return;
          isDragging = false;
          debouncedSaveCoverState();

          document.removeEventListener('mousemove', doDrag);
          document.removeEventListener('touchmove', doDrag);
          document.removeEventListener('mouseup', endDrag);
          document.removeEventListener('touchend', endDrag);
        }

        function setupExternalResizeEvents() {
          const resizeBtn = document.getElementById('ext-resize-btn');

          resizeBtn.addEventListener('mousedown', startResize);
          resizeBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startResize(e.touches[0]);
          }, { passive: false });
        }

        function startResize(e) {
          if (!currentCircleData || currentCircleData.locked) return;

          isResizing = true;
          const rect = currentCircleData.element.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          resizeStartDistance = Math.sqrt(Math.pow(e.clientX - centerX, 2) + Math.pow(e.clientY - centerY, 2));
          resizeStartSize = currentCircleData.element.offsetWidth;

          document.addEventListener('mousemove', doResize);
          document.addEventListener('touchmove', doResize, { passive: false });
          document.addEventListener('mouseup', endResize);
          document.addEventListener('touchend', endResize);
        }

        function doResize(e) {
          if (!isResizing || !currentCircleData) return;
          e.preventDefault();

          const clientX = e.clientX || (e.touches && e.touches[0].clientX);
          const clientY = e.clientY || (e.touches && e.touches[0].clientY);

          if (!clientX || !clientY) return;

          const rect = currentCircleData.element.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          const currentDistance = Math.sqrt(Math.pow(clientX - centerX, 2) + Math.pow(clientY - centerY, 2));
          const delta = currentDistance - resizeStartDistance;

          const newSize = Math.max(60, Math.min(250, resizeStartSize + (delta / pageScale) * 1.5));

          currentCircleData.element.style.width = newSize + 'px';
          currentCircleData.element.style.height = newSize + 'px';
          currentCircleData.size = newSize;

          updateExternalControlsPosition();
        }

        function endResize() {
          if (!isResizing) return;
          isResizing = false;
          debouncedSaveCoverState();

          document.removeEventListener('mousemove', doResize);
          document.removeEventListener('touchmove', doResize);
          document.removeEventListener('mouseup', endResize);
          document.removeEventListener('touchend', endResize);
        }

        function setupImageEdit(circleData, container) {
          let imgDragging = false;
          let imgStartX, imgStartY;
          let imgInitialOffsetX, imgInitialOffsetY;
          let initialPinchDistance = 0;
          let initialPinchScale = 1;

          const MOVE_SENSITIVITY = 0.5;
          const SCALE_STEP = 0.02;

          container.addEventListener('touchstart', (e) => {
            if (!circleData.locked || !circleData.hasImage) return;
            e.stopPropagation(); // Stop propagation to zoom container

            if (e.touches.length === 2) {
              e.preventDefault();
              const touch1 = e.touches[0];
              const touch2 = e.touches[1];
              initialPinchDistance = Math.sqrt(
                Math.pow(touch2.clientX - touch1.clientX, 2) +
                Math.pow(touch2.clientY - touch1.clientY, 2)
              );
              initialPinchScale = circleData.imgScale;
              return;
            }

            imgDragging = true;
            imgStartX = e.touches[0].clientX;
            imgStartY = e.touches[0].clientY;
            imgInitialOffsetX = circleData.imgOffsetX;
            imgInitialOffsetY = circleData.imgOffsetY;
          }, { passive: false });

          container.addEventListener('touchmove', (e) => {
            if (!circleData.locked || !circleData.hasImage) return;
            e.stopPropagation(); // Stop propagation

            if (e.touches.length === 2) {
              e.preventDefault();
              const touch1 = e.touches[0];
              const touch2 = e.touches[1];
              const currentDistance = Math.sqrt(
                Math.pow(touch2.clientX - touch1.clientX, 2) +
                Math.pow(touch2.clientY - touch1.clientY, 2)
              );
              const scale = currentDistance / initialPinchDistance;
              circleData.imgScale = Math.max(0.2, Math.min(5, initialPinchScale * scale));
              updateImageTransform(circleData);
              return;
            }

            if (!imgDragging) return;
            e.preventDefault();

            const clientX = e.touches[0].clientX;
            const clientY = e.touches[0].clientY;

            const dx = (clientX - imgStartX) / pageScale / circleData.imgScale * MOVE_SENSITIVITY;
            const dy = (clientY - imgStartY) / pageScale / circleData.imgScale * MOVE_SENSITIVITY;

            circleData.imgOffsetX = imgInitialOffsetX + dx;
            circleData.imgOffsetY = imgInitialOffsetY + dy;

            updateImageTransform(circleData);
          }, { passive: false });

          container.addEventListener('touchend', (e) => {
            if (!circleData.locked || !circleData.hasImage) return;
            e.stopPropagation();

            if (e.touches.length < 2) {
              initialPinchDistance = 0;
            }
            if (e.touches.length === 0) {
              imgDragging = false;
              debouncedSaveCoverState();
            }
          }, { passive: true }); // passive true for touchend usually fine, but if we stopProp, might want false? simpler to just keep consistent logic.

          container.addEventListener('wheel', (e) => {
            if (!circleData.locked || !circleData.hasImage) return;
            e.stopPropagation();
            e.preventDefault();

            const delta = e.deltaY > 0 ? -SCALE_STEP : SCALE_STEP;
            circleData.imgScale = Math.max(0.2, Math.min(5, circleData.imgScale + delta));
            updateImageTransform(circleData);
            debouncedSaveCoverState();
          }, { passive: false });

          container.addEventListener('mousedown', (e) => {
            if (!circleData.locked || !circleData.hasImage) return;
            e.stopPropagation();
            e.preventDefault();
            imgDragging = true;
            imgStartX = e.clientX;
            imgStartY = e.clientY;
            imgInitialOffsetX = circleData.imgOffsetX;
            imgInitialOffsetY = circleData.imgOffsetY;
          });

          document.addEventListener('mousemove', (e) => {
            if (!imgDragging || !circleData.locked || !circleData.hasImage) return;
            // e.stopPropagation(); // document listener, hard to stop prop here, but logic checks flags
            e.preventDefault();

            const dx = (e.clientX - imgStartX) / pageScale / circleData.imgScale * MOVE_SENSITIVITY;
            const dy = (e.clientY - imgStartY) / pageScale / circleData.imgScale * MOVE_SENSITIVITY;

            circleData.imgOffsetX = imgInitialOffsetX + dx;
            circleData.imgOffsetY = imgInitialOffsetY + dy;

            updateImageTransform(circleData);
          });

          document.addEventListener('mouseup', () => {
            if (imgDragging) {
              imgDragging = false;
              debouncedSaveCoverState();
            }
          });
        }

        function updateExternalControlsPosition() {
          if (!currentCircleData || !externalControls.classList.contains('show')) return;

          const circle = currentCircleData.element;
          const rect = circle.getBoundingClientRect();

          const controlsWidth = 100;
          let left = rect.left + (rect.width / 2) - (controlsWidth / 2);
          let top = rect.bottom + 10;

          left = Math.max(10, Math.min(window.innerWidth - controlsWidth - 10, left));
          top = Math.max(10, Math.min(window.innerHeight - 60, top));

          externalControls.style.left = left + 'px';
          externalControls.style.top = top + 'px';
          externalControls.style.position = 'fixed';
          externalControls.style.transform = `scale(${Math.max(0.8, Math.min(1, pageScale))})`;
          externalControls.style.transformOrigin = 'top center';
        }

        function setActiveCircle(circleId) {
          document.querySelectorAll('.logo-circle').forEach(c => c.classList.remove('active'));

          const circleData = circles.find(c => c.id === circleId);
          if (circleData) {
            circleData.element.classList.add('active');
            activeCircleId = circleId;
            currentCircleData = circleData;

            if (circleData.locked) {
              externalControls.classList.remove('show');
              externalControls.classList.add('locked');
            } else {
              externalControls.classList.add('show');
              externalControls.classList.remove('locked');
              setTimeout(updateExternalControlsPosition, 10);
            }
          } else {
            activeCircleId = null;
            currentCircleData = null;
            externalControls.classList.remove('show');
            externalControls.classList.remove('locked');
          }
          updateCirclesMenu();
          updateActiveButtons();
        }

        function updateActiveButtons() {
          const circleData = circles.find(c => c.id === activeCircleId);
          if (circleData && circleData.hasImage) {
            activeLockBtn.style.display = 'inline-flex';
            activeDeleteImgBtn.style.display = 'inline-flex';
            const icon = activeLockBtn.querySelector('i');
            if (circleData.locked) {
              icon.className = 'fa-solid fa-lock';
              activeLockBtn.classList.add('active');
            } else {
              icon.className = 'fa-solid fa-lock-open';
              activeLockBtn.classList.remove('active');
            }
          } else {
            activeLockBtn.style.display = 'none';
            activeDeleteImgBtn.style.display = 'none';
          }
        }

        activeLockBtn.addEventListener('click', () => {
          const circleData = circles.find(c => c.id === activeCircleId);
          if (!circleData) return;

          circleData.locked = !circleData.locked;
          circleData.element.classList.toggle('locked', circleData.locked);

          if (circleData.locked) {
            externalControls.classList.remove('show');
            externalControls.classList.add('locked');
          } else {
            externalControls.classList.add('show');
            externalControls.classList.remove('locked');
            updateExternalControlsPosition();
          }

          updateActiveButtons();
          updateCirclesMenu();
          debouncedSaveCoverState();
        });

        activeDeleteImgBtn.addEventListener('click', () => {
          const circleData = circles.find(c => c.id === activeCircleId);
          if (!circleData || !circleData.hasImage) return;

          const img = document.getElementById(`${circleData.id}-img`);
          const input = document.getElementById(`${circleData.id}-input`);

          img.src = '';
          input.value = '';
          circleData.element.classList.remove('image-loaded');
          circleData.hasImage = false;
          circleData.imgScale = 1;
          circleData.imgOffsetX = 0;
          circleData.imgOffsetY = 0;

          if (circleData.locked) {
            circleData.locked = false;
            circleData.element.classList.remove('locked');
          }

          updateActiveButtons();
          updateCirclesMenu();
          debouncedSaveCoverState();
        });

        function deleteCircle(circleId) {
          const index = circles.findIndex(c => c.id === circleId);
          if (index === -1) return;

          const circleData = circles[index];
          circleData.element.remove();
          circles.splice(index, 1);

          if (activeCircleId === circleId) {
            activeCircleId = null;
            currentCircleData = null;
            externalControls.classList.remove('show');
            externalControls.classList.remove('locked');
            updateActiveButtons();
          }

          updateCirclesMenu();
          debouncedSaveCoverState();
        }

        function updateCirclesMenu() {
          if (circles.length === 0) {
            circlesList.innerHTML = '<div class="empty-state">لا توجد شعارات مضافة<br>اضغط + لإضافة شعار</div>';
            return;
          }

          circlesList.innerHTML = '';
          circles.forEach((circleData, index) => {
            const item = document.createElement('div');
            item.className = 'circle-item' + (circleData.id === activeCircleId ? ' active' : '');

            const img = document.getElementById(`${circleData.id}-img`);
            const preview = circleData.hasImage && img.src
              ? `<img src="${img.src}" alt="">`
              : '<i class="fa-solid fa-circle"></i>';

            const status = circleData.locked ? '🔒' : (circleData.hasImage ? '✓' : '○');

            item.innerHTML = `
                        <div class="circle-item-info">
                            <div class="circle-item-preview">${preview}</div>
                            <span class="circle-item-name">ش ${index + 1} ${status}</span>
                        </div>
                        <button class="circle-item-delete" data-id="${circleData.id}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    `;

            item.addEventListener('click', (e) => {
              if (e.target.closest('.circle-item-delete')) return;
              setActiveCircle(circleData.id);
            });

            item.querySelector('.circle-item-delete').addEventListener('click', () => {
              deleteCircle(circleData.id);
            });

            circlesList.appendChild(item);
          });
        }

        manageCirclesBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          circlesMenu.classList.toggle('show');
          coverColorDropdown.style.display = 'none';
          coverFrameDropdown.style.display = 'none';
        });

        addNewCircleBtn.addEventListener('click', () => {
          createCircle();
        });

        coverColorBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          coverColorDropdown.style.display = coverColorDropdown.style.display === 'block' ? 'none' : 'block';
          circlesMenu.classList.remove('show');
          coverFrameDropdown.style.display = 'none';
        });

        coverFrameBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          coverFrameDropdown.style.display = coverFrameDropdown.style.display === 'block' ? 'none' : 'block';
          circlesMenu.classList.remove('show');
          coverColorDropdown.style.display = 'none';
        });

        let activeTextElement = null; // New variable to track active text element

        document.addEventListener('click', (e) => {
          const isToolbar = e.target.closest('.toolbar');
          const isEditable = e.target.closest('.editable');
          const isDropdown = e.target.closest('.dropdown-container');
          const isColorPicker = e.target.closest('#cover-color-picker-group');
          const isFramePicker = e.target.closest('#frame-picker-group');

          if (!isDropdown) {
            circlesMenu.classList.remove('show');
          }
          if (!isColorPicker) {
            coverColorDropdown.style.display = 'none';
          }
          if (!isFramePicker) {
            coverFrameDropdown.style.display = 'none';
          }

          // Logic for text selection persistence
          if (isEditable) {
            activeTextElement = isEditable;
            // Ensure visual feedback
            document.querySelectorAll('.editable').forEach(el => el.classList.remove('cover-line-target'));
            activeTextElement.classList.add('cover-line-target');
            updateToolbarForSelection(activeTextElement);
          } else if (!isToolbar) {
            // Clicked outside toolbar and outside editable -> clear selection
            activeTextElement = null;
            document.querySelectorAll('.editable').forEach(el => {
              el.classList.remove('cover-line-target');
            });
          }
          // If clicked on toolbar, do NOT clear activeTextElement

          if (!e.target.closest('.logo-circle') && !e.target.closest('.external-controls')) {
            document.querySelectorAll('.logo-circle').forEach(c => c.classList.remove('active'));
            externalControls.classList.remove('show');
            externalControls.classList.remove('locked');
            activeCircleId = null;
            currentCircleData = null;
            updateActiveButtons();
          }
        });

        function saveCoverState() {
          try {
            const circlesData = circles.map(c => ({
              id: c.id,
              hasImage: c.hasImage,
              imgSrc: c.hasImage ? document.getElementById(`${c.id}-img`).src : null,
              locked: c.locked,
              x: c.x,
              y: c.y,
              size: c.size,
              imgScale: c.imgScale,
              imgOffsetX: c.imgOffsetX,
              imgOffsetY: c.imgOffsetY
            }));

            const currentFrame = Array.from(coverPage.classList).find(c => c.startsWith('frame-style-') && c !== 'frame-style-0');

            const state = {
              texts: {},
              layout: {
                isLtr: coverPage.classList.contains('ltr'),
                padding: coverPaddingSelect.value,
                frame: currentFrame || null
              },
              circles: circlesData,
              circleCounter: circleCounter,
              pageScale: pageScale
              // panX: panX, // Removed
              // panY: panY // Removed
            };

            coverPage.querySelectorAll('.editable').forEach(el => {
              state.texts[el.id] = el.innerHTML;
            });

            const stateString = JSON.stringify(state);
            if (stateString.length > 4000000) {
              circlesData.forEach(c => c.imgSrc = null);
              localStorage.setItem(COVER_STORAGE_KEY, JSON.stringify(state));
            } else {
              localStorage.setItem(COVER_STORAGE_KEY, stateString);
            }
          } catch (err) {
            console.warn('فشل الحفظ:', err);
          }
        }

        function loadCoverState() {
          try {
            const saved = localStorage.getItem(COVER_STORAGE_KEY);
            if (!saved) {
              setDefaultTextSizes();
              adjustPageDisplay();
              return;
            }

            const state = JSON.parse(saved);

            Object.keys(state.texts).forEach(id => {
              const el = document.getElementById(id);
              if (el) el.innerHTML = state.texts[id];
            });

            if (state.layout.isLtr) coverPage.classList.add('ltr');
            coverPaddingSelect.value = state.layout.padding || '15mm';
            coverPage.style.padding = coverPaddingSelect.value;

            if (state.layout.frame && state.layout.frame !== 'frame-style-0') {
              coverPage.classList.add(state.layout.frame);
            }

            if (state.pageScale) {
              pageScale = state.pageScale;
              // panX = state.panX || 0; // Removed
              // panY = state.panY || 0; // Removed
              updateTransform();
            }

            if (state.circleCounter) circleCounter = state.circleCounter;
            if (state.circles) {
              state.circles.forEach(circleData => {
                const circle = document.createElement('div');
                circle.id = circleData.id;
                circle.className = 'logo-circle' +
                  (circleData.hasImage ? ' image-loaded' : '') +
                  (circleData.locked ? ' locked' : '');

                const size = circleData.size || 100;
                circle.style.width = size + 'px';
                circle.style.height = size + 'px';
                circle.style.left = (circleData.x || 10) + 'px';
                circle.style.top = (circleData.y || 10) + 'px';

                const placeholderDisplay = circleData.hasImage ? 'none' : 'block';
                const imgSrc = circleData.imgSrc || '';

                circle.innerHTML = `
                                <i class="fa-solid fa-image placeholder-icon" style="display:${placeholderDisplay};"></i>
                                <div class="img-container" id="${circleData.id}-img-container">
                                    <img id="${circleData.id}-img" src="${imgSrc}" alt="" draggable="false" />
                                </div>
                                <input type="file" id="${circleData.id}-input" accept="image/*" style="display:none;" />
                            `;

                circlesContainer.appendChild(circle);

                const newCircleData = {
                  id: circleData.id,
                  element: circle,
                  hasImage: circleData.hasImage,
                  locked: circleData.locked,
                  x: circleData.x || 10,
                  y: circleData.y || 10,
                  size: size,
                  imgScale: circleData.imgScale || 1,
                  imgOffsetX: circleData.imgOffsetX || 0,
                  imgOffsetY: circleData.imgOffsetY || 0
                };

                circles.push(newCircleData);
                setupCircleEvents(newCircleData);

                if (circleData.hasImage && imgSrc) {
                  setTimeout(() => updateImageTransform(newCircleData), 50);
                }
              });

              updateCirclesMenu();
            }

            setTimeout(adjustPageDisplay, 100);
          } catch (err) {
            console.warn('فشل التحميل:', err);
            setDefaultTextSizes();
            adjustPageDisplay();
          }
        }

        function setDefaultTextSizes() {
          document.querySelectorAll('.editable').forEach(el => {
            if (!el.style.fontSize) {
              el.style.fontSize = '18pt';
            }
          });
        }

        coverPage.querySelectorAll('.editable').forEach(el => {
          el.addEventListener('focus', (e) => {
            el.classList.add('cover-line-target');
            setTimeout(() => {
              const rect = el.getBoundingClientRect();
              const containerHeight = zoomContainer.clientHeight;
              const scrollTop = zoomContainer.scrollTop;
              const targetY = rect.top + scrollTop - (containerHeight / 2) + (rect.height / 2);

              zoomContainer.scrollTo({
                top: targetY,
                behavior: 'smooth'
              });
            }, 300);
          });

          el.addEventListener('blur', () => {
            // Do not remove class immediately on blur, let click handler manage it
            // This allows toolbar clicks to work on the last focused element
          });

          el.addEventListener('click', (e) => {
            e.stopPropagation();
            // Logic handled in global click listener for consistency
            activeTextElement = el;
            document.querySelectorAll('.editable').forEach(e => e.classList.remove('cover-line-target'));
            el.classList.add('cover-line-target');
            updateToolbarForSelection(el);
          });

          el.addEventListener('input', debouncedSaveCoverState);

          el.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
            debouncedSaveCoverState();
          });
        });

        function updateToolbarForSelection(element) {
          const computedStyle = window.getComputedStyle(element);
          const fontSize = parseInt(computedStyle.fontSize);
          coverFontSizeSelect.value = fontSize || 18;

          const fontFamily = computedStyle.fontFamily.replace(/['"]/g, '').split(',')[0].trim();
          for (let i = 0; i < coverFontFamilySelect.options.length; i++) {
            if (coverFontFamilySelect.options[i].value === fontFamily) {
              coverFontFamilySelect.selectedIndex = i;
              break;
            }
          }
        }

        document.querySelectorAll('[data-cover-command]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            // Use persistent variable
            const activeEl = activeTextElement;
            if (!activeEl) return;

            const cmd = btn.dataset.coverCommand;
            const style = activeEl.style;
            const computed = window.getComputedStyle(activeEl);

            switch (cmd) {
              case 'bold':
                style.fontWeight = (computed.fontWeight === 'bold' || parseInt(computed.fontWeight) >= 700) ? 'normal' : 'bold';
                break;
              case 'italic':
                style.fontStyle = computed.fontStyle === 'italic' ? 'normal' : 'italic';
                break;
              case 'underline':
                style.textDecoration = computed.textDecorationLine.includes('underline') ? 'none' : 'underline';
                break;
            }

            debouncedSaveCoverState();
          });
        });

        coverFontFamilySelect.addEventListener('change', (e) => {
          const activeEl = activeTextElement;
          if (activeEl) {
            // Add quotes to font family to ensure names with spaces (like 'Noto Naskh Arabic') work correctly
            activeEl.style.fontFamily = `'${e.target.value}'`;
            debouncedSaveCoverState();
          }
        });

        coverFontSizeSelect.addEventListener('change', (e) => {
          const activeEl = activeTextElement;
          if (activeEl) {
            activeEl.style.fontSize = e.target.value + 'pt';
            debouncedSaveCoverState();
          }
        });

        coverPaddingSelect.addEventListener('change', () => {
          coverPage.style.padding = coverPaddingSelect.value;
          debouncedSaveCoverState();
        });

        coverToggleLayoutBtn.addEventListener('click', () => {
          coverPage.classList.toggle('ltr');
          debouncedSaveCoverState();
        });

        coverSaveBtn.addEventListener('click', async () => {
          externalControls.style.display = 'none';
          document.querySelectorAll('.logo-circle').forEach(c => c.classList.remove('active'));
          circlesMenu.classList.remove('show');
          coverColorDropdown.style.display = 'none';
          coverFrameDropdown.style.display = 'none';

          try {
            // Save and reset transform on WRAPPER (where resizing happens)
            const originalTransform = coverPageWrapper.style.transform;
            coverPageWrapper.style.transform = 'none';

            // We also need to be careful with zoomContent sizing if it clips
            // Best practice: temporarily force full size
            const originalZoomContentWidth = zoomContent.style.width;
            const originalZoomContentHeight = zoomContent.style.height;
            zoomContent.style.width = '';
            zoomContent.style.height = '';

            // Capture
            const canvas = await html2canvas(coverPage, {
              scale: EXPORT_SCALE, // 3
              useCORS: true,
              backgroundColor: '#ffffff',
              removeContainer: true,
              imageTimeout: 0,
              logging: false,
              onclone: (clonedDoc) => {
                const content = clonedDoc.getElementById('cover-page');
                // Fix for Arabic text spacing issues in html2canvas
                if (content) {
                  content.style.letterSpacing = 'normal';
                  content.style.wordSpacing = 'normal';
                  Array.from(content.querySelectorAll('*')).forEach(el => {
                    el.style.letterSpacing = 'normal';
                    el.style.wordSpacing = 'normal';
                  });
                }
              }
            });

            // Restore
            coverPageWrapper.style.transform = originalTransform;
            zoomContent.style.width = originalZoomContentWidth;
            zoomContent.style.height = originalZoomContentHeight;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
              orientation: 'portrait',
              unit: 'mm',
              format: 'a4'
            });

            // Use PNG for better quality
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`غلاف_${Date.now()}.pdf`);
          } catch (error) {
            console.error("خطأ في الحفظ:", error);
            alert('فشل حفظ PDF');
          } finally {
            externalControls.style.display = '';
            // Ensure active state is restored if any (though we cleared active state above)
            // If we want to be safe, just call updateTransform to recalculate everything
            updateTransform();
          }
        });

        setupExternalDragEvents();
        setupExternalResizeEvents();

        loadCoverState();
      });
    </script>
</body>

</html></textarea>

  <script>
    const reportParts = [];
    let coverImageData = null; // Store cover image as Base64

    // Cover Designer Functions
    function openCoverDesigner() {
      const modal = document.getElementById('coverModal');
      const frame = document.getElementById('coverDesignerFrame');
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';

      // قراءة كود مصمم الغلاف من textarea المخفي
      let code = document.getElementById('cover-designer-code').value;

      // تعديل تلقائي: استبدال حفظ PDF بإرسال الصورة للتطبيق الرئيسي
      code = code.replace(
        /const\s*\{\s*jsPDF\s*\}[\s\S]*?pdf\.save\([\s\S]*?\);/,
        "const imageData = canvas.toDataURL('image/png');\n        window.parent.postMessage({ type: 'COVER_SAVED', imageData: imageData }, '*');"
      );

      frame.srcdoc = code;
    }

    function closeCoverDesigner() {
      const modal = document.getElementById('coverModal');
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    // Listen for messages from Cover Designer iframe
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'COVER_SAVED') {
        coverImageData = e.data.imageData;
        document.getElementById('coverReadyIcon').style.display = 'inline';
        closeCoverDesigner();
      }
    });

    function addReportPart() {
      const textarea = document.getElementById('htmlInput');
      const html = textarea.value.trim();

      if (!html) {
        textarea.style.borderColor = '#ff3333';
        setTimeout(() => {
          textarea.style.borderColor = 'rgba(0,255,65,.2)';
        }, 300);
        return;
      }

      reportParts.push(html);
      textarea.value = '';
      textarea.focus();
      updatePartsBar();
    }

    function updatePartsBar() {
      const bar = document.getElementById('partsBar');

      if (reportParts.length === 0) {
        bar.innerHTML = '';
        return;
      }

      bar.innerHTML = reportParts.map((part, index) => `
      <div class="part-chip" title="الجزء ${index + 1}">
      <span>${index + 1}</span>
      <button onclick="removePart(${index})" title="حذف">×</button>
    </div>
      `).join('');
    }

    function removePart(index) {
      reportParts.splice(index, 1);
      updatePartsBar();
    }

    function clearAll() {
      reportParts.length = 0;
      updatePartsBar();
      document.getElementById('htmlInput').value = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const pre = document.querySelector('.code-stream');
      if (pre && !pre.dataset.duplicated) {
        pre.dataset.duplicated = '1';
        const t = pre.textContent || '';
        pre.textContent = t + "\n" + t;
      }

      const htmlInput = document.getElementById('htmlInput');
      htmlInput.maxLength = 10000000;
    });

    function detectReportLanguage(html) {
      if (!html) return 'ar';

      const langMatch = html.match(/lang=["']([^"']+)["']/i);
      const dirMatch = html.match(/dir=["']([^"']+)["']/i);

      if (langMatch) {
        const lang = langMatch[1].toLowerCase();
        if (lang.startsWith('en')) return 'en';
        if (lang.startsWith('ar')) return 'ar';
      }

      if (dirMatch) {
        const dir = dirMatch[1].toLowerCase();
        if (dir === 'ltr') return 'en';
        if (dir === 'rtl') return 'ar';
      }

      const arabicChars = (html.match(/[\u0600-\u06FF]/g) || []).length;
      const englishChars = (html.match(/[a-zA-Z]/g) || []).length;

      if (englishChars > arabicChars * 2) return 'en';
      return 'ar';
    }

    function _extractTitleFromHTML(raw) {
      if (!raw) return "";
      const m = raw.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
      if (!m) return "";
      return (m[1] || "").replace(/\s+/g, " ").trim();
    }
    function _escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
    function _sanitizeFileName(name) {
      const n = String(name || "").trim() || "برغموت";
      return n.replace(/[\\/:*?"<>|]+/g, " ").replace(/\s+/g, " ").trim();
    }

    function validateHTML(html) {
      const warnings = [];
      if (!html || html.trim().length === 0) {
        return ["الحقل فارغ"];
      }
      if (!html.includes('<')) {
        warnings.push("لا يبدو أن هذا كود HTML صالح");
      }
      const openTags = (html.match(/<[a-zA-Z][^>]*>/g) || []).length;
      const closeTags = (html.match(/<\/[a-zA-Z][^>]*>/g) || []).length;
      const selfClosing = (html.match(/<[^>]*\/>/g) || []).length;

      if (Math.abs(openTags - closeTags - selfClosing) > 2) {
        warnings.push("قد تكون هناك وسوم غير مغلقة");
      }
      return warnings;
    }

    function openGuideModal() {
      const m = document.getElementById("guideModal");
      if (!m) return;
      m.classList.add("show");
      m.setAttribute("aria-hidden", "false");
      document.body.classList.add("modal-open");
    }
    function closeGuideModal() {
      const m = document.getElementById("guideModal");
      if (!m) return;
      m.classList.remove("show");
      m.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    }
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeGuideModal();
    });

    let abortController = null;
    let isExporting = false;

    function printReport() {
      const currentHtml = document.getElementById('htmlInput').value.trim();
      const allParts = [...reportParts];
      if (currentHtml) {
        allParts.push(currentHtml);
      }

      // Allow export if we have cover OR parts
      if (allParts.length === 0 && !coverImageData) {
        const exportBtn = document.getElementById('exportBtn');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = "<span style='color:#D32F2F'>أين الكود؟</span>";
        setTimeout(() => exportBtn.innerHTML = originalText, 1500);
        return;
      }

      // Detect language from first part
      const firstPart = allParts[0] || '';
      const lang = typeof detectReportLanguage === 'function' ? detectReportLanguage(firstPart) : 'ar';
      const dir = lang === 'ar' ? 'rtl' : 'ltr';

      // Extract title for filename
      let title = "برغموت - تقرير";
      if (typeof _extractTitleFromHTML === 'function') {
        const extractedTitle = _extractTitleFromHTML(firstPart);
        if (extractedTitle) title = extractedTitle;
      }

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        alert("يرجى السماح بالنوافذ المنبثقة");
        return;
      }

      const doc = printWindow.document;
      doc.open();
      // Set the extracted title here so the saved PDF name matches
      doc.write('<!DOCTYPE html><html dir="' + dir + '" lang="' + lang + '"><head><meta charset="utf-8"><title>' + title + '</title>');
      doc.write('<style>');
      doc.write('@media print {');
      doc.write('  @page { margin: 0; size: A4; }');
      doc.write('  html, body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; width: 210mm; }');
      doc.write('  * { box-sizing: border-box; }');
      doc.write('  .page-break { display: block; width: 100%; page-break-before: always; break-inside: avoid; position: relative; }');
      doc.write('  .page-break:first-child { page-break-before: auto; }');
      doc.write('  .cover-page { width: 210mm; height: 297mm; margin: 0; padding: 0; overflow: hidden; position: relative; }');
      doc.write('  .cover-page img { width: 100%; height: 100%; object-fit: cover; display: block; }');
      doc.write('}');
      doc.write('body { font-family: "IBM Plex Arabic", "Arial", sans-serif; margin: 0; }');
      doc.write('</style>');
      doc.write('</head><body>');

      // Add cover as first page if available
      if (coverImageData) {
        doc.write('<div class="cover-page">');
        doc.write('<img src="' + coverImageData + '" alt="غلاف التقرير">');
        doc.write('</div>');
      }

      // Add all HTML parts
      allParts.forEach((part) => {
        if (part.trim() !== "") {
          doc.write('<div class="page-break">' + part + '</div>');
        }
      });

      doc.write('</body></html>');
      doc.close();

      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
      }, 500);
    }

    async function mergePdfFiles(files) {
      if (!files || files.length === 0) return;

      const fileCount = files.length;
      if (!confirm(`هل تريد دمج ${fileCount} ملفات PDF؟`)) {
        document.getElementById('pdfInput').value = '';
        return;
      }

      try {
        const { PDFDocument } = PDFLib;
        const mergedPdf = await PDFDocument.create();

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await PDFDocument.load(arrayBuffer);
          const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
          copiedPages.forEach((page) => mergedPdf.addPage(page));
        }

        const pdfBytes = await mergedPdf.save();

        // Download the merged PDF
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'merged_bergamot.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        alert('تم دمج الملفات بنجاح!');
      } catch (error) {
        console.error('Error merging PDFs:', error);
        alert('حدث خطأ أثناء دمج الملفات: ' + error.message);
      }

      // Reset input
      document.getElementById('pdfInput').value = '';
    }
  </script>
</body>

</html>
